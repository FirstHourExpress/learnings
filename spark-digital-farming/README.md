# [Simulating Crop Emergence Rate with Spark and Scala](https://github.com/FirstHourExpress/learnings/tree/main/spark-digital-farming)

The goal of this project is to calculate the average values of soilMoisture and soilTemp in the time interval between plantingDate and emergenceDate for each cropID for different ranges of emergencRate. We have two tables to achieve this goal:

- `soil`: This is a soil table with columns `lat`, `lon`, `date`, `soilTemp`, and `soilMoisture`.
- `GS`: This is a growth stage table with columns `lat`, `lon`, `cropID`, `fieldID`, `plantingDate`, `emergenceDate`, and some other primary growth stages.

Each soil measurement site has a latitude and longitude which are stored in the `lat` and `lon` fields of the two tables. By joining the two tables on `lat` and `lon`, we can associate each date in the soil dataframe with its corresponding `plantingDate`, `emergenceDate`, `cropID`, and `fieldID`.

We need to make two more columns - `emergencDays` which is the difference between `emergenceDate` and `plantingDate`, and `emergencRate`. If `emergencDays` is less than 5 days, `emergencRate` is considered fast, between 5-10 days is average, and more than 10 days is slow.

In order to achieve our goal, we need to group-by on `cropID` and `emergencRate`. Then for each combination of `cropID` and `emergencRate`, we need to filter the dates between `plantingDate` and `emergenceDate` and calculate the average `soilTemp` and `soilMoisture`.


## Randomly generated dataframes

The Simulator object contains two functions, createGSDF and createSoilDF, which are used to create data frames for soil and growth stages (GS) respectively.

The `createGSDF` function generates a data frame for GS with columns for latitude (`lat`), longitude (`lon`), crop ID (`cropID`), planting date (`plantingDate`), and emergence date (`emergenceDate`). It takes in several parameters including the number of rows, number of unique crop IDs, number of unique sites, start and end dates, and returns the GS data frame.

The `createSoilDF` function generates a data frame for soil with columns for latitude (`lat`), longitude (`lon`), date, soil moisture, and soil temperature. It takes in the GS data frame generated by `createGSDF`, start and end dates, and returns the soil data frame. This function first generates a sequence of dates using `getDateRange` function from the `Utils` object. It then joins the sequence of dates with the GS data frame, creating a new data frame that combines the unique latitudes and longitudes with each date in the range. Finally, it adds randomly generated values for soil moisture and temperature for each latitude, longitude, and date combination.


## Spark and Scala for Dataframe Operations
`emergence.scala` performs an analysis of the emergence rate of crops based on soil data. It first creates a growth stage data frame and a soil data frame using the Simulator object's createGSDF and createSoilDF functions. It then joins the two data frames based on the "lat" and "lon" columns, calculates the difference between the "emergenceDate" and "plantingDate" columns to create a new "emergenceDays" column, and categorizes the emergence rate as "fast", "average", or "slow" based on the number of days it takes for emergence to occur. It then groups the result by the "cropID" and "emergenceRate" columns and aggregates the mean soil temperature and moisture for each group.
